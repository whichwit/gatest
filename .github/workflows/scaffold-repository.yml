name: Scaffold Repository

on:
  workflow_dispatch:
    inputs:
      repository:
        description: 'Repository name'
        required: true
        type: string
      token:
        description: 'GitHub token with repo permissions'
        required: true
        type: string
      create_repository:
        description: 'Create a new repository'
        required: false
        default: true
        type: boolean
      create_environment:
        description: 'Create deployment environments'
        required: false
        default: true
        type: boolean
      branch_name:
        description: 'Name of the new branch to create from template (leave empty to skip)'
        required: false
        default: ''
        type: string
      infra_name:
        description: 'Infrastructure project name (leave empty to skip)'
        required: false
        default: ''
        type: string
      ecr_repository:
        description: 'ECR repository name (leave empty to skip)'
        required: false
        default: ''
        type: string

jobs:
  check-repo-availability:
    if: ${{ inputs.create_repository }}
    runs-on: ubuntu-latest
    steps:
      - name: Check new repository availability
        id: check_repo
        env:
          GH_TOKEN: ${{ inputs.token }}
        run: |
          if gh repo view amsrun/${{ inputs.repository }} > /dev/null 2>&1; then
            echo "::error::Repository ${{ inputs.repository }} already exists. Cannot proceed."
            exit 1
          fi

  check-repo-existence:
    if: ${{ !inputs.create_repository }}
    runs-on: ubuntu-latest
    steps:
      - name: Check repository exists
        id: check_repo
        env:
          GH_TOKEN: ${{ inputs.token }}
        run: |
          if ! gh repo view amsrun/${{ inputs.repository }} > /dev/null 2>&1; then
            echo "::error::Repository ${{ inputs.repository }} does not exist. Cannot proceed."
            exit 1
          fi

  scaffold-repository:
    needs: [check-repo-availability, check-repo-existence]
    if: ${{ !cancelled() && !contains(needs.*.result, 'failure') && inputs.create_repository }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout template repository
        uses: actions/checkout@v4

      # - name: Setup Terraform
      #   uses: hashicorp/setup-terraform@v3

      - name: Scaffold Repository with Terraform
        id: scaffold_repo
        uses: ./actions/scaffold-repository
        with:
          repository: ${{ inputs.repository }}
          token: ${{ inputs.token }}
          variables: |
            github_token = "${{ inputs.token }}"
            github_repository = "${{ inputs.repository }}"

  scaffold-environment:
    needs: [check-repo-availability, check-repo-existence, scaffold-repository]
    if: ${{ !cancelled() && !contains(needs.*.result, 'failure') && inputs.create_environment }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout template repository
        uses: actions/checkout@v4

      # - name: Setup Terraform
      #   uses: hashicorp/setup-terraform@v3

      - name: Setup Deployment Environment with Terraform
        id: setup_deployment_environment
        uses: ./actions/scaffold-environment
        with:
          repository: ${{ inputs.repository }}
          token: ${{ inputs.token }}
          variables: |
            github_token = "${{ inputs.token }}"
            github_repository = "${{ inputs.repository }}"
            environment_secrets = {
              "development": {
                "AWS_ACCESS_KEY_ID": "${{ secrets.IAM_AWS_CICD_ACCESSKEY_DEV }}",
                "AWS_SECRET_ACCESS_KEY": "${{ secrets.IAM_AWS_CICD_SECRETID_DEV }}"
              },
              "staging": {
                "AWS_ACCESS_KEY_ID": "${{ secrets.IAM_AWS_CICD_ACCESSKEY_STAGING }}",
                "AWS_SECRET_ACCESS_KEY": "${{ secrets.IAM_AWS_CICD_SECRETID_STAGING }}"
              },
              "production": {
                "AWS_ACCESS_KEY_ID": "${{ secrets.IAM_AWS_CICD_ACCESSKEY_PROD }}",
                "AWS_SECRET_ACCESS_KEY": "${{ secrets.IAM_AWS_CICD_SECRETID_PROD }}"
              }
            }
            environment_variables = {
              "development": {
                "AWS_ACCOUNT_ID": "559587901710",
                "AWS_REGION": "us-east-2",
                "AWS_DEPLOYMENT_ROLE": "d-${{ inputs.infra_name }}-deployment"
              },
              "staging": {
                "AWS_ACCOUNT_ID": "001553724852",
                "AWS_REGION": "us-east-2",
                "AWS_DEPLOYMENT_ROLE": "s-${{ inputs.infra_name }}-deployment"
              },
              "production": {
                "AWS_ACCOUNT_ID": "870288520478",
                "AWS_REGION": "us-east-2",
                "AWS_DEPLOYMENT_ROLE": "p-${{ inputs.infra_name }}-deployment"
              }
            }
            repository_variables = {
              "INFRASTRUCTURE_PROJECT": "${{ inputs.infra_name }}",
              "ECR_REPOSITORY": "${{ inputs.ecr_repository }}"
            }

  scaffold-branch:
    needs: [check-repo-availability, check-repo-existence, scaffold-repository]
    if: ${{ !cancelled() && !contains(needs.*.result, 'failure') && inputs.branch_name != '' }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout template repository
        uses: actions/checkout@v4

      - name: Check if branch already exists
        id: check_branch
        env:
          GH_TOKEN: ${{ inputs.token }}
        run: |
          if gh api repos/amsrun/${{ inputs.repository }}/branches/${{ inputs.branch_name }} > /dev/null 2>&1; then
            echo "âœ… Branch '${{ inputs.branch_name }}' already exists. Skipping scaffold."
            echo "branch_exists=true" >> $GITHUB_OUTPUT
          else
            echo "branch_exists=false" >> $GITHUB_OUTPUT
          fi

      - name: Create Default Branch from Template
        if: ${{ steps.check_branch.outputs.branch_exists != 'true' }}
        id: scaffold_branch_name
        uses: ./actions/scaffold-branch
        with:
          repository: ${{ inputs.repository }}
          token: ${{ inputs.token }}
          branch: ${{ inputs.branch_name }}